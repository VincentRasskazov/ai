<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VincentAI | Advanced</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --bg: #0e0e0e;
            --sidebar: #171717;
            --surface: #1e1e1e;
            --border: #333333;
            --primary: #4f46e5;
            --primary-glow: rgba(79, 70, 229, 0.4);
            --text-main: #ededed;
            --text-dim: #a1a1aa;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 260px;
            background: var(--sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            transition: transform 0.3s ease;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 2rem;
            color: white;
            letter-spacing: -0.5px;
        }

        .new-chat-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .new-chat-btn:hover { background: var(--border); }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-item {
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
        }

        .history-item:hover { background: rgba(255,255,255,0.05); color: white; }

        .settings-area {
            border-top: 1px solid var(--border);
            padding-top: 1rem;
            margin-top: auto;
        }

        .settings-btn {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-dim);
            text-align: left;
            padding: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-btn:hover { color: white; }

        /* --- MAIN AREA --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* border-bottom: 1px solid var(--border); */
        }

        .model-pill {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        select {
            background: transparent;
            border: none;
            color: var(--text-main);
            outline: none;
            font-family: inherit;
            cursor: pointer;
        }

        /* --- CHAT FEED --- */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 15%; /* Center column look */
            display: flex;
            flex-direction: column;
            gap: 2rem;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            gap: 1.5rem;
            animation: fadeUp 0.3s ease;
            max-width: 100%;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .avatar.ai { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; box-shadow: 0 0 15px var(--primary-glow); }
        .avatar.user { background: var(--surface); color: var(--text-dim); border: 1px solid var(--border); }

        .content {
            flex: 1;
            line-height: 1.7;
            font-size: 1rem;
            color: #d4d4d8;
            min-width: 0; /* Fix code block overflow */
        }

        /* Markdown Styles */
        .content h1, .content h2, .content h3 { margin-top: 0.5em; color: white; }
        .content p { margin-bottom: 0.8em; }
        .content code { background: #2d2d30; padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: #e06c75; }
        .content pre { 
            background: #1e1e1e !important; 
            padding: 1rem; 
            border-radius: 8px; 
            overflow-x: auto; 
            border: 1px solid var(--border);
            position: relative;
        }
        .content pre code { 
            background: transparent; 
            color: inherit; 
            padding: 0;
            display: block;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .copy-btn:hover { background: rgba(255,255,255,0.2); color: white; }

        /* --- INPUT --- */
        .input-area {
            padding: 2rem 15%;
            background: linear-gradient(to top, var(--bg) 80%, transparent);
        }

        .input-wrapper {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 10px 16px;
            display: flex;
            align-items: flex-end; /* Align bottom for multiline */
            gap: 10px;
            transition: border 0.2s;
            position: relative;
        }

        .input-wrapper:focus-within { border-color: var(--primary); }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            padding: 10px 0;
            max-height: 150px;
            outline: none;
        }

        .action-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .action-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .send-btn { background: white; color: black; border-radius: 8px; }
        .send-btn:hover { background: #e0e0e0; color: black; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- MODAL --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            width: 300px;
            text-align: center;
        }
        .modal input {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            background: var(--bg);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
        }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            aside { display: none; }
            #chat-container, .input-area { padding: 1rem; }
        }
    </style>
</head>
<body>

    <aside>
        <div class="brand">
            <i class="fa-solid fa-gem text-indigo-500"></i> VincentAI
        </div>
        <button class="new-chat-btn" onclick="clearChat()">
            <i class="fa-solid fa-plus"></i> New Chat
        </button>
        <div class="history-list" id="history-list">
            </div>
        <div class="settings-area">
            <button class="settings-btn" onclick="openAuthModal()">
                <i class="fa-solid fa-lock"></i> API Security
            </button>
        </div>
    </aside>

    <main>
        <header>
            <div class="model-pill">
                <i class="fa-solid fa-microchip text-indigo-400"></i>
                <select id="model-select">
                    <option value="DeepSeek V3.2">DeepSeek V3.2 (Fast)</option>
                    <option value="Llama 3.3 70B Instruct">Llama 3.3 (Smart)</option>
                    <option value="Qwen3 30B">Qwen3 30B</option>
                    <option value="GPT-4o mini">GPT-4o mini</option>
                    <option value="Gemma 3 12B">Gemma 3 12B</option>
                </select>
            </div>
        </header>

        <div id="chat-container">
            <div class="message">
                <div class="avatar ai"><i class="fa-solid fa-bolt"></i></div>
                <div class="content">
                    <p>Hello. I am <strong>VincentAI</strong>, running on a secure proxy.</p>
                    <p>I support Markdown, Code Highlighting, and Image Generation tools. Try asking me to write Python code or generate an image.</p>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <button class="action-btn" title="Generate Image" onclick="insertImagePrompt()">
                    <i class="fa-regular fa-image"></i>
                </button>
                <textarea id="user-input" rows="1" placeholder="Ask anything..." oninput="autoResize(this)"></textarea>
                <button id="send-btn" class="action-btn send-btn" onclick="handleSend()">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
            <div style="text-align: center; font-size: 0.7rem; color: #555; margin-top: 10px;">
                AI can make mistakes. Check important info.
            </div>
        </div>
    </main>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h3><i class="fa-solid fa-shield-halved"></i> Security Vault</h3>
            <p style="font-size: 0.8rem; color: #aaa;">Enter your Render Backend Password</p>
            <input type="password" id="api-password" placeholder="e.g. vincent-secret">
            <button class="btn-primary" onclick="savePassword()">Unlock Access</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const BACKEND_URL = "https://backendai-ablv.onrender.com"; 

        // --- STATE ---
        let password = localStorage.getItem('vincent_key') || '';
        const history = JSON.parse(localStorage.getItem('vincent_history') || '[]');

        // --- UI ELEMENTS ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modelSelect = document.getElementById('model-select');
        const authModal = document.getElementById('auth-modal');

        // --- INITIALIZATION ---
        // Configure Markdown (marked.js)
        marked.setOptions({
            highlight: function(code, lang) {
                const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                return highlight.highlight(code, { language }).value;
            },
            langPrefix: 'hljs language-'
        });

        if (!password) {
            authModal.style.display = 'flex';
        }

        renderHistory();

        // --- CORE FUNCTIONS ---

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. Add User Message
            addMessage('user', text);
            userInput.value = '';
            userInput.style.height = 'auto'; // Reset height
            saveToHistory(text);

            // 2. Create Placeholder for AI
            const aiMsgDiv = addMessage('ai', '<span class="typing">Thinking...</span>');
            const contentDiv = aiMsgDiv.querySelector('.content');

            try {
                // 3. Send Request
                const response = await fetch(`${BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                        "x-vincent-password": password // SECURE HEADER
                    },
                    body: JSON.stringify({
                        message: text,
                        model: modelSelect.value
                    })
                });

                if (response.status === 401) {
                    contentDiv.innerHTML = `<span style="color: #ef4444;">üîí Access Denied. Please check your password in Settings.</span>`;
                    openAuthModal();
                    return;
                }

                if (!response.ok) throw new Error("Backend Error");

                const rawText = await response.text();

                // 4. Stream/Typewriter Effect
                typeWriterEffect(contentDiv, rawText);

            } catch (err) {
                contentDiv.innerHTML = `<span style="color: #ef4444;">‚ö†Ô∏è Connection Failed. Ensure your Render backend is awake.</span>`;
            }
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'message';
            
            const avatar = role === 'user' 
                ? `<div class="avatar user"><i class="fa-solid fa-user"></i></div>`
                : `<div class="avatar ai"><i class="fa-solid fa-bolt"></i></div>`;
            
            // Initial render (user text isn't markdown parsed to prevent XSS on input, AI is)
            const initialContent = role === 'user' ? text : text; 

            div.innerHTML = `
                ${avatar}
                <div class="content">${initialContent}</div>
            `;
            
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return div;
        }

        function typeWriterEffect(element, text) {
            element.innerHTML = ''; // Clear "Thinking..."
            let index = 0;
            const speed = 5; // ms per char

            function type() {
                if (index < text.length) {
                    // Just append text for now, we parse Markdown at the end for performance
                    // or chunk it. For simplicity in this demo, we append chars.
                    element.textContent += text.charAt(index);
                    index++;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    setTimeout(type, speed);
                } else {
                    // 5. Finalize: Render Markdown & Highlight Code
                    element.innerHTML = marked.parse(text);
                    hljs.highlightAll();
                    addCopyButtons(element);
                }
            }
            type();
        }

        // --- UTILS ---

        function addCopyButtons(element) {
            element.querySelectorAll('pre').forEach(pre => {
                const btn = document.createElement('button');
                btn.className = 'copy-btn';
                btn.innerText = 'Copy';
                btn.onclick = () => {
                    navigator.clipboard.writeText(pre.innerText);
                    btn.innerText = 'Copied!';
                    setTimeout(() => btn.innerText = 'Copy', 2000);
                };
                pre.appendChild(btn);
            });
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function insertImagePrompt() {
            userInput.value = "Generate an image of ";
            userInput.focus();
        }

        // --- AUTH & HISTORY ---

        function openAuthModal() {
            authModal.style.display = 'flex';
        }

        function savePassword() {
            const input = document.getElementById('api-password');
            if (input.value) {
                password = input.value;
                localStorage.setItem('vincent_key', password);
                authModal.style.display = 'none';
            }
        }

        function saveToHistory(text) {
            if (history.length > 0 && history[0] === text) return; // Dedupe
            history.unshift(text);
            if (history.length > 20) history.pop();
            localStorage.setItem('vincent_history', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.textContent = item;
                div.onclick = () => { userInput.value = item; userInput.focus(); };
                list.appendChild(div);
            });
        }

        function clearChat() {
            chatContainer.innerHTML = `
                <div class="message">
                    <div class="avatar ai"><i class="fa-solid fa-bolt"></i></div>
                    <div class="content">
                        <p>Chat cleared. Ready for new instructions.</p>
                    </div>
                </div>`;
        }

        // Enter key to send (Shift+Enter for newline)
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
    </script>
</body>
</html>
